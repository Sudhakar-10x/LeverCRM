
<input type="text" id="itemSearchBox" class="form-control" placeholder="Search by Name or Code (min 4 chars)" />

<div class="table-responsive">
    <table class="table table-bordered table-hover" id="itemTable">
        <thead>
            <tr>
                <th>#</th>
                <th>Name</th>
                <th>Code</th>
                <th>Select</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>
<script>
    var itemTable;

    function loadItemTable(query) {
        const customerTypeVal = 1; // $('input[name="entity.CallType"]:checked').val();

        $.ajax({
            url: '@Url.Action("GetItemList", "SalesOrder")',
            type: 'GET',
            data: {
                searchTerm: query,
                customertype: customerTypeVal,
                _: new Date().getTime() // Prevents caching
            },
            success: function (response) {
                const data = response.data || response; // Handles both { data: [] } and []

                if ($.fn.DataTable.isDataTable('#itemTable')) {
                    itemTable.clear().rows.add(data).draw();
                } else {
                    itemTable = $('#itemTable').DataTable({
                        searching: false,
                        lengthChange: false,
                        paging: true,
                        data: data,
                        columns: [
                            { data: null, render: (data, type, row, meta) => meta.row + 1 },
                            { data: "ItemName" },
                            { data: "ItemCode" },
                            {
                                data: null,
                                render: function (data, type, row) {
                                    return `<button class='btn btn-sm btn-primary select-customer'
                                        data-code='${row.ItemCode}'
                                        data-id='${row.ItemCode}'
                                        data-name='${row.ItemName}'>Select</button>`;
                                },
                                className: "text-center"
                            }
                        ]
                    });
                }
            },
            error: function () {
                alert('Failed to load customer data.');
            }
        });
    }

    $(document).ready(function () {
        $('#itemSearchBox').on('keyup', function () {
            const query = $(this).val().trim();
            if (query.length >= 4) {
                loadItemTable(query);
            } else if (itemTable) {
                itemTable.clear().draw();
            }
        });

        $('#itemTable').on('click', '.select-customer', function () {
            const ItemCode = $(this).data("id");
            const ItemName = $(this).data("name");

            $('#entity_CustomerID').val(ItemCode);
            $('#ItemName').val(ItemCode);

            setTimeout(() => {
                $('#customerlist-form-modal').modal('hide');
            }, 100);

            //loadAddresses(customerID);
            if (typeof onCustomerSelected === "function") {
                onItemSelected2(ItemCode);
            }
        });

        $('#customerlist-form-modal').on('shown.bs.modal', function () {
            $('#itemSearchBox').val('');

            if ($.fn.DataTable.isDataTable('#itemTable')) {
                itemTable.clear().draw();
            } else {
                itemTable = $('#itemTable').DataTable({
                    searching: false,
                    lengthChange: false,
                    paging: true,
                    data: [],
                    columns: [
                        { data: null, render: (data, type, row, meta) => meta.row + 1 },
                        { data: "ItemName" },
                        { data: "PhoneNo" },
                        { data: "EmailID" },
                        {
                            data: null,
                            render: function (data, type, row) {
                                return `<button class='btn btn-sm btn-primary select-customer'
                                    data-code='${row.ItemCode}'
                                    data-id='${row.ItemCode}'
                                    data-name='${row.Name}'>Select</button>`;
                            },
                            className: "text-center"
                        }
                    ]
                });
            }
        });

        $('#customerlist-form-modal').on('hidden.bs.modal', function () {
            $('#itemSearchBox').val('');
            if (itemTable) {
                itemTable.clear().draw();
            }
        });
    });
</script>